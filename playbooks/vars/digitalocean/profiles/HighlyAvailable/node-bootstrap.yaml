---

_instance_type: s-4vcpu-8gb
userdata_config_source: "{{ bootstrap_ign_url }}"

_def:
  name: "{{ cluster_state.infra_id }}-bootstrap"
  region: "{{ cluster_state.region }}"
  project: "{{ cluster_state.infra_id }}"
  image_id: "{{ cluster_state.compute.image_id }}"
  instance_type: "{{ _instance_type }}"
  state: present
  vpc_name: "{{ cluster_state.infra_id }}-vpc"
  wait: yes
  wait_timeout: 500

compute_resources:

# https://docs.ansible.com/ansible/latest/collections/community/digitalocean/digital_ocean_droplet_module.html
    - provider: do
      #filters:
      #  tag:Name: "{{ _def.name }}"
      #  instance-state-name: running
      #tags: "{% set x=cluster_state.tags.__setitem__('Name', _def.name ) %}{{ cluster_state.tags }}"
      #security_groups: "{{ _def.security_groups }}"
      #volumes: "{{ _def.volumes | d([]) }}"
      #user_data: "{{ lookup('template', 'ocp-bootstrap-user-data.j2') | to_nice_json | string | b64encode }}"
      #user_data: "{{ lookup('template', 'ocp-bootstrap-user-data.j2') }}"
      #user_data: "{{ lookup('template', 'ocp-bootstrap-user-data.j2') | string }}"
      #user_data: "{{ lookup('template', 'ocp-bootstrap-user-data.j2') | to_json }}"
      #user_data: "{{ lookup('template', 'ocp-bootstrap-user-data.j2') | to_json | string }}"
      user_data: "{{ lookup('template', 'ocp-bootstrap-user-data.j2') }}"
      vpc_name: "{{ _def.vpc_name }}"
      wait: "{{ _def.wait }}"
      wait_timeout: "{{ _def.wait_timeout }}"

      #firewall: "{{ _def.firewall }}"
      image_name: "{{ _def.image_id }}"
      #ipv6: no
      #monitoring: no

      #sleep_interval: 
      ssh_key:
        name: "{{ _def.project }}"
        pub_key: "{{ config_ssh_key }}"
      #tags: 
      #user_data: 
      #volumes:
      spec:
        state: present
        name: "{{ _def.name }}"
        unique_name: true
        size: "{{ _def.instance_type }}"
        region: "{{ _def.region }}"
        project_name: "{{ _def.project }}"
        private_networking: true
        wait_timeout: 500
        #wait: no
        ipv6: false
        monitoring: false
        tags:
        - "{{ _def.project }}-control-planes"
        - "cluster-name-{{ _def.project }}"

      callbacks:
        - service: dns
          domain: "{{ cluster_state.dns.cluster_domain }}"
          rr_type: A
          rr_name: "{{ _def.name }}"
          droplet_network: v4
          droplet_network_type: private