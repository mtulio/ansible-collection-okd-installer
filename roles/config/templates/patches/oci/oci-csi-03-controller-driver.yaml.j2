apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    deprecated.daemonset.template.generation: "1"
  generation: 1
  name: csi-oci-controller
  namespace: {{ oci_csi_namespace }}
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: csi-oci-controller
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: csi-oci-controller
        role: csi-oci
    spec:
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      containers:
        - name: csi-volume-provisioner
          image: k8s.gcr.io/sig-storage/csi-provisioner:v3.2.1
          args:
            - --csi-address=/var/run/shared-tmpfs/csi.sock
            - --volume-name-prefix=csi
            - --feature-gates=Topology=true
            - --timeout=120s
            - --leader-election
            - --leader-election-namespace={{ oci_csi_namespace }}
          volumeMounts:
            - name: config
              mountPath: /etc/oci/
              readOnly: true
            - mountPath: /var/run/shared-tmpfs
              name: shared-tmpfs
          env:
          - name: KUBERNETES_PORT
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP_ADDR
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_PORT_443_TCP_PORT
            value: "6443"
          - name: KUBERNETES_PORT_443_TCP_PROTO
            value: "tcp"
          - name: KUBERNETES_SERVICE_HOST
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_SERVICE_PORT
            value: "6443"
          - name: KUBERNETES_SERVICE_PORT_HTTPS
            value: "6443"

        - name: csi-fss-volume-provisioner
          image: k8s.gcr.io/sig-storage/csi-provisioner:v3.2.1
          args:
            - --csi-address=/var/run/shared-tmpfs/csi-fss.sock
            - --volume-name-prefix=csi-fss
            - --feature-gates=Topology=true
            - --timeout=120s
            - --leader-election
            - --leader-election-namespace={{ oci_csi_namespace }}
          volumeMounts:
            - name: config
              mountPath: /etc/oci/
              readOnly: true
            - mountPath: /var/run/shared-tmpfs
              name: shared-tmpfs
          env:
          - name: KUBERNETES_PORT
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP_ADDR
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_PORT_443_TCP_PORT
            value: "6443"
          - name: KUBERNETES_PORT_443_TCP_PROTO
            value: "tcp"
          - name: KUBERNETES_SERVICE_HOST
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_SERVICE_PORT
            value: "6443"
          - name: KUBERNETES_SERVICE_PORT_HTTPS
            value: "6443"

        - name: csi-attacher
          image: k8s.gcr.io/sig-storage/csi-attacher:v4.2.0
          args:
            - --csi-address=/var/run/shared-tmpfs/csi.sock
            - --timeout=120s
            - --leader-election=true
            - --leader-election-namespace={{ oci_csi_namespace }}
          volumeMounts:
            - name: config
              mountPath: /etc/oci/
              readOnly: true
            - mountPath: /var/run/shared-tmpfs
              name: shared-tmpfs
          env:
          - name: KUBERNETES_PORT
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP_ADDR
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_PORT_443_TCP_PORT
            value: "6443"
          - name: KUBERNETES_PORT_443_TCP_PROTO
            value: "tcp"
          - name: KUBERNETES_SERVICE_HOST
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_SERVICE_PORT
            value: "6443"
          - name: KUBERNETES_SERVICE_PORT_HTTPS
            value: "6443"

        - name: csi-resizer
          image: k8s.gcr.io/sig-storage/csi-resizer:v1.7.0
          args:
            - --csi-address=/var/run/shared-tmpfs/csi.sock
            - --leader-election
          imagePullPolicy: "IfNotPresent"
          volumeMounts:
            - mountPath: /var/run/shared-tmpfs
              name: shared-tmpfs
          env:
          - name: KUBERNETES_PORT
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP_ADDR
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_PORT_443_TCP_PORT
            value: "6443"
          - name: KUBERNETES_PORT_443_TCP_PROTO
            value: "tcp"
          - name: KUBERNETES_SERVICE_HOST
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_SERVICE_PORT
            value: "6443"
          - name: KUBERNETES_SERVICE_PORT_HTTPS
            value: "6443"
        
        - name: oci-csi-controller-driver
          args:
            - --endpoint=unix://var/run/shared-tmpfs/csi.sock
            - --fss-csi-endpoint=unix://var/run/shared-tmpfs/csi-fss.sock
          command:
            - /usr/local/bin/oci-csi-controller-driver
          image: ghcr.io/oracle/cloud-provider-oci:v1.25.0
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: config
              mountPath: /etc/oci/
              readOnly: true
            - name: kubernetes
              mountPath: /etc/kubernetes
              readOnly: true
            - mountPath: /var/run/shared-tmpfs
              name: shared-tmpfs
          env:
          - name: KUBERNETES_PORT
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP
            value: "tcp://api-int.{{ cluster_name }}.{{ config_base_domain }}:6443"
          - name: KUBERNETES_PORT_443_TCP_ADDR
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_PORT_443_TCP_PORT
            value: "6443"
          - name: KUBERNETES_PORT_443_TCP_PROTO
            value: "tcp"
          - name: KUBERNETES_SERVICE_HOST
            value: "api-int.{{ cluster_name }}.{{ config_base_domain }}"
          - name: KUBERNETES_SERVICE_PORT
            value: "6443"
          - name: KUBERNETES_SERVICE_PORT_HTTPS
            value: "6443"

      volumes:
        - name: config
          secret:
            secretName: oci-volume-provisioner
        - name: kubernetes
          hostPath:
            path: /etc/kubernetes
        - name: shared-tmpfs
          emptyDir: {}
      dnsPolicy: ClusterFirst
      hostNetwork: true
      imagePullSecrets:
        - name: image-pull-secret
      restartPolicy: Always
      schedulerName: default-scheduler
      serviceAccount: csi-oci-node-sa
      serviceAccountName: csi-oci-node-sa
      terminationGracePeriodSeconds: 30
      tolerations:
        - operator: Exists
