---
- name: Destroy | VPC | AWS
  debug:
    msg: "Destroy VPC triggered"
  tags: vpc

- name: VPC | AWS | Set VPC Id for Zone name
  set_fact:
    vpc_name: "{{ cloud_networks[0].name }}"
    vpc_region: "{{ cloud_networks[0].region }}"
    vpc_cidr: "{{ cloud_networks[0].block }}"
  tags: vpc

- name: VPC | AWS | Get VPC by Name
  amazon.aws.ec2_vpc_net_info:
    filters:
      "tag:Name": "{{ vpc_name }}"
  when: vpc_name is defined
  register: vpc_info
  tags: vpc

- name: VPC | AWS | Set VPC Id for Zone name
  set_fact:
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
  when:
    - vpc_name is defined
    - vpc_info.vpcs|length > 0
  tags: vpc

- block:
    - include: aws-vpc-natgw.yaml
      tags: vpc

    - include: aws-vpc-sgs.yaml
      tags: vpc

    - include: aws-vpc-endpoint.yaml
      tags: vpc

    - include: aws-vpc-rtb.yaml
      tags: vpc

    - include: aws-vpc-subnets.yaml
      tags: vpc

    - include: aws-vpc-igw.yaml
      tags: vpc

    - include: aws-vpc-cagw.yaml
      tags: vpc

    - name: AWS | VPC delete
      ec2_vpc_net:
        state: absent
        region: "{{ vpc_region }}"
        name: "{{ vpc_name }}"
        cidr_block: "{{ vpc_cidr }}"
      register: ret_vpc
      tags: vpc

    - name: AWS | VPC | Show delete result
      debug:
        var: ret_vpc
      tags: vpc

  when:
    - (vpc_id is defined) and (vpc_id != '')
  tags: vpc
